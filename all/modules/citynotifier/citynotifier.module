<?php

module_load_include('inc', 'citynotifier');

/**
* Implements hook_menu().
*/

function citynotifier_menu() {
  $items['admin/citynotifier'] = array(
    'title'=>t('Amministrazione di Citynotifier'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_citynotifier_admin_form'),
    'access arguments' => array('citynotifier administrator'),
    'file' => 'citynotifier.admin.inc',
    'type' => MENU_CALLBACK
  );
    
  $items['richieste'] = array(
    'title'=>t('Richiesta'),
    'page callback' => 'citynotifier_request',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
  
  $items['segnalazione'] = array(
    'title'=>t('Segnalazione'),
    'page callback' => 'citynotifier_report',
    'access arguments' => array('access content'),
    'access callback' => true,
    'file' => 'citynotifier.admin.inc',
    'type' => MENU_CALLBACK,
    );
  
  $items['notifica'] = array(
    'title'=>t('Notifica'),
    'page callback' => 'citynotifier_notify',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
  
  $items['login'] = array(
    'title'=>t('Login'),
    'page callback' => 'citynotifier_login',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
 
  $items['logout'] = array(
    'title'=>t('Logout'),
    'page callback' => 'citynotifier_logout',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
    
  return $items;
}

/**
* Implements hook_permission().
*/
function citynotifier_permission(){
    return array(
        'citynotifier administrator' => array(
            'title' => t('Amministratore di Citynotifier'),
            'description' => t('Utenti che possono amministrare Citynotifier'),
        ),
    );
}


/**
 * Implements hook_help().
 */
function citynotifier_help($path, $arg) {
  switch ($path) {
    case 'admin/citynotifier':
      $output = '';
      $output .= '<h3>' . t('Amministrazione di citynotifier') . '</h3>';
      $output .= '<p>' . t('Seleziona la url da dove scaricare i server da interrogare e quindi seleziona i server scelti') . '</p>';
      return $output;
  }
}


function citynotifier_login() {
  global $user;
  header('Content-type: application/json; charset=utf-8');
  $login = drupal_json_decode(file_get_contents("php://input"));

    
  if(!$login['username'] || !$login['password']) {
    watchdog('citynotifier', t('Errore nello username o nella password'), array(), WATCHDOG_WARNING);
    drupal_add_http_header("Status", 406);
    drupal_json_output(array("result" => t("Errore nello username o nella password")));
    return;
  };
  
  if ($user->uid) {
    citynotifier_debug($user);
    watchdog('citynotifier', t('Esiste un utente già loggato'), array(), WATCHDOG_WARNING);
    drupal_add_http_header("Status", 406);
    drupal_json_output(array("result" => t("Esiste un utente già loggato")));
    return;
  }

  $uid = user_authenticate($login['username'], $login['password']);
  
  if ($uid) {
    $user = user_load($uid);
    if ($user->uid) {
      user_login_finalize();
      
      watchdog('citynotifier', t('Si è loggato l\'utente %name.'), array('%name' => $user->name));
      drupal_add_http_header("Status", 200);
      return drupal_json_output(array("result" => t("login effettuato con successo"), "username" => $user->name, "session_id" => session_id(), "session_name" => session_name()));
    }
  }
  
  watchdog('citynotifier', t("Username o password sbagliati per %username"), array('%username' => $login['username']), WATCHDOG_WARNING);
  drupal_add_http_header("Status", 401);
  return drupal_json_output(array("result" => t("Username o password sbagliati")));
}

function citynotifier_logout() {
  global $user;
  header('Content-type: application/json; charset=utf-8');

  if (!$user->uid) {
    drupal_add_http_header("Status", 406); 
    return drupal_json_output(array("result" => t("Non c'è nessun utente per cui fare logout")));
  }

  watchdog('citynotifier', t('Ha fatto logout l\'utente %name.'), array('%name' => $user->name));

  // Destroy the current session.
  module_invoke_all('user_logout', $user);
  session_destroy();

  // Load the anonymous user.
  $user = drupal_anonymous_user();

  drupal_add_http_header("Status", 200);
  return drupal_json_output(array("result" => t("logout effettuato con successo")));
}

function citynotifier_request() {
  header('Content-type: application/json; charset=utf-8');
  
  $validation =_citynotifier_validate($_GET, 'request');
  
  if($validation['code'] <> 200) {
    drupal_add_http_header("Status", $validation['code'], $validation['response']);
    return;
  }
_citynotifier_create_event_to_resp(); 
  $fake_resp = array("request_time" => 1368095111,
		"result" => "Messaggio di servizio",
		"from_server" => "http://ltw1234.web.cs.unibo.it",
		"events" => array(
						array(
						  "event_id" => "902438",
					      "type" => array("type" => "problemi_stradali", "subtype" => "incidente"),
					      "description" => array("ommioddio","come na catapulta","","",""),
					      "start_time" => 1368045665,
					      "freshness" => 1368085800,
				          "status" => "open",
					      "reliability" => 0.2,
					      "number_of_notifications" => 2,
					      "locations" => array(
					      					array("lat" => 44.501678, "lng" => 11.339865),
								   			array("lat" => 44.501621, "lng" => 11.339682)
								  		)
		           		),
				   		array(
					      "event_id" => "902439",
					      "type" => array("type" => "problemi_stradali", "subtype" => "incidente"),
					      "description" => array("mi hanno tamponato","dottore chiami un dottore","che guaio","descr4","descr5"),
					      "start_time" => 1368105698,
					      "freshness" => 1368106058,
				          "status" => "open",
					      "reliability" => 0.9,
					      "number_of_notifications" => 4,
					      "locations" => array(
					      					array("lat" => 44.498885, "lng" => 11.345401),
								   			array("lat" => 44.499253, "lng" => 11.345465),
								   			array("lat" => 44.498954, "lng" => 11.345165),
								   			array("lat" => 44.498748, "lng" => 11.345251)
								  		)
		           		)
		           )
               );
  
  drupal_add_http_header("Status", 200);
  echo drupal_json_output($fake_resp);

}

function _citynotifier_create_event_to_resp() {
	$status = _citynotifier_get_index_status($_GET['status']);
	extract(_citynotifier_get_index_type_subtype($data, 1), EXTR_OVERWRITE);

	$lonmin = $_GET['lng']-$_GET['radius']/abs(cos(deg2rad($_GET['lat']))*69);
	$lonmax = $_GET['lng']+$_GET['radius']/abs(cos(deg2rad($_GET['lat']))*69);

	$latmin = $_GET['lat']-($_GET['radius']/69);
	$latmax = $_GET['lat']+($_GET['radius']/69);

/*	$query = db_query("SELECT event_id, lat, lng, 3956 * 2 * ASIN(SQRT(POWER(SIN((".$_GET['lat']." -lat) * pi()/180 / 2), 2) +COS(".$_GET['lat']." * pi()/180) * COS(lat * pi()/180) *POWER(SIN((".$_GET['lng']." -lon) * pi()/180 / 2), 2) )) as distance 
		FROM citynotifier_notify
		WHERE lng between $lonmin and $lonmax and lat between $latmin and $latmax 
		having distance < ".$_GET['radius']." ORDER BY Distance limit 10;"
		)->fetchAll;*/

	$query = db_select("citynotifier_event", 'ce');
	$query->join("citynotifier_notify", 'cn', 'ce.event_id = cn.event_id');
	$query->fields('ce', array('event_id','type','subtype','status'));
	$query->addExpression('MAX(cn.created)', 'freshness');
	$query->addExpression('MIN(cn.created)', 'start');
	$query->condition('ce.type', $type, '=')
		->condition('ce.subtype', $subtype, '=')
		/*->condition('cn.lat', $latmin,'>')
		->condition('cn.lat', $latmax,'<')
		->condition('cn.lng', $lonmax,'>')
		->condition('cn.lng', $lonmin,'<')*/
		->condition('ce.status', $status,'=')
		->havingCondition('freshness', $_GET['timemin'], '>')
		->havingCondition('freshness', $_GET['timemax'], '<');
	$query->groupBy('ce.event_id');

	$events = $query->execute();//->fetchAll();

	foreach($events as $event){
		$query = db_select("citynotifier_event", 'ce');
		$query->join("citynotifier_notify", 'cn', 'ce.event_id = cn.event_id');
//		$query->fields('cn', array('uid','lat','lng','description'));
		$query->addExpression('COUNT(*)', 'number_of_notifications');
		$query->condition('ce.event_id', $event->event_id, '=');
		$query->groupBy('ce.event_id');
		$nOn = $query->execute()->fetchAll();
//$profile = user_load($uid);

citynotifier_debug($nOn);
	}

	return $events;
}

function citynotifier_debug($data) {
  if (is_array($data) || is_object($data))
    $data = print_r($data, TRUE);
  $data .= "\n";
  error_log($data, 3, "/tmp/citynotifier_debug.log");
}
