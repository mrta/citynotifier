<?php

module_load_include('inc', 'citynotifier');

global $index, $types, $subtypes;

$index = array("scope","type","subtype","lat","lng","radius","timemin","timemax","status");
$types = array("all", "problemi_stradali", "emergenze_sanitarie", "reati", "problemi_ambientali", "eventi_pubblici");
$subtypes = array("all" => array("all"),
                         "problemi_stradali" => array("incidente", "buca", "coda", "lavori_in_corso", "strada_impraticabile"),
                         "emergenze_sanitarie" => array("incidente", "malore", "ferito"),
                         "reati" => array("furto", "attentato"),
                         "problemi_ambientali" => array("incendio", "tornado", "neve", "alluvione"),
                         "eventi_pubblici" => array("partita", "manifestazione", "concerto")); 



/**
* Implements hook_menu().
*/

function citynotifier_menu() {
  $items['richieste'] = array(
    'page callback' => 'citynotifier_request',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
  
  $items['segnalazione'] = array(
    'title'=>t('Segnalazione'),
    'page callback' => 'citynotifier_report',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
  
  $items['notifica/%'] = array(
    'page callback' => 'citynotifier_notify',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
  
  $items['login'] = array(
    'title'=>t('Login'),
    'page callback' => 'citynotifier_login',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
 
  $items['logout'] = array(
    'title'=>t('Logout'),
    'page callback' => 'citynotifier_logout',
    'access arguments' => array('access content'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
    );
    
  return $items;
}

function citynotifier_login() {
  header('Content-type: application/json');
  $login = drupal_json_decode(file_get_contents("php://input"));
  
  if(!$login['username'] || !$login['password']) {
    watchdog('citynotifier', t('Errore nello username o nella password'), array(), WATCHDOG_WARNING);
    drupal_add_http_header("Status", 406);
    drupal_json_output(array("result" => t("Errore nello username o nella password")));
    return;
  };
   
  if(!user_authenticate($login['username'], $login['password'])) {
    watchdog('citynotifier', t("Username o password sbagliati"), array(), WATCHDOG_WARNING);
    drupal_add_http_header("Status", 406);
    drupal_json_output(array("result" => t("Username o password sbagliati")));
    return;
  }
  
  drupal_add_http_header("Status", 200);
  drupal_json_output(array("result" => t("login effettuato con successo")));
}

function citynotifier_logout() {
  header('Content-type: application/json');
  $result = array("result" => "logout effettuato con successo");
  echo drupal_json_output($result);
}

function citynotifier_request() {
  _citynotifier_validate_request(func_get_args());
  
  $fake_resp = array("request_time" => 1368095111,
		"result" => "Messaggio di servizio",
		"from_server" => "http://ltw1234.web.cs.unibo.it",
		"events" => array("event_id" => "902438",
			          "type" => array("type" => "problemi_stradali", "subtype" => "incidente"),
			          "description" => array("ommioddio","come na catapulta","","",""),
			          "start_time" => 1368045665,
			          "freshness" => 1368085800,
		                  "status" => "open",
			          "reliability" => 0.8,
			          "number_of_notifications" => 2,
			          "locations" => array(array("lat" => 37.42291810, "lng" => -122.08542120),
						       array("lat" => 37.42291811, "lng" => -122.08542120)
						      )
               			  ),
			    array("event_id" => "902438",
			          "type" => array("type" => "problemi_stradali", "subtype" => "incidente"),
			          "description" => array("mi hanno tamponato","dottore chiami un dottore","che guaio","descr4","descr5"),
			          "start_time" => 1368105698,
			          "freshness" => 1368106058,
		                  "status" => "open",
			          "reliability" => 0.9,
			          "number_of_notifications" => 4,
			          "locations" => array(array("lat" => 37.42291815, "lng" => -122.08542120),
						       array("lat" => 37.42291814, "lng" => -122.08542121),
						       array("lat" => 37.42291812, "lng" => -122.08542122),
						       array("lat" => 37.42291813, "lng" => -122.08542123)
						      )
               			  )
               );
  citynotifier_debug($fake_resp);
  drupal_add_http_header("Status", 200);
  echo drupal_json_output($fake_resp);

}

function _citynotifier_validate_request($args) {
  
  $args2validate = array();
  foreach($index as $i => $a)
    $args2validate[$a] = $args[$i];
  
  if($args2validate['scope'] <> "local" && $args2validate['scope'] <> "remote") {
    drupal_add_http_header("Status", 406, "Not validate scope");
    return;
  }
  
  if(!in_array($args2validate['type'], $types)) {
    drupal_add_http_header("Status", 406, "Not validate type");
    return;
  }
  
  if(!in_array($args2validate['subtype'], $subtypes[$args2validate['type']])) {
    drupal_add_http_header("Status", 406, "Not validate subtype");
    return;
  }

  if(!in_array($args2validate['subtype'], $subtypes[$args2validate['type']])) {
    drupal_add_http_header("Status", 406, "Not validate subtype");
    return;
  }
  
  if(!is_float($args2validate['lat'])) {
    drupal_add_http_header("Status", 406, "Not validate lat");
    return;
  }
  
  if(!is_float($args2validate['lng'])) {
    drupal_add_http_header("Status", 406, "Not validate lng");
    return;
  }
  
  if(!is_float($args2validate['radius'])) {
    drupal_add_http_header("Status", 406, "Not validate radius");
    return;
  }
  
  //var_dump($args2validate);
}


function citynotifier_debug($data) {
  if (is_array($data) || is_object($data))
    $data = print_r($data, TRUE);
  $data .= "\n";
  error_log($data, 3, "/tmp/citynotifier_debug.log");
}
